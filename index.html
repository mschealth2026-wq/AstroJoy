<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroVision Pro - Fixed Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .house-card { background: #1e293b; border: 1px solid #334155; }
        .planet-tag { background: #0369a1; color: #7dd3fc; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin: 2px; display: inline-block; border: 1px solid #0ea5e9; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.1); border-left-color: #38bdf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-sky-400 mb-2">AstroVision Pro</h1>
            <p class="text-slate-400 italic">Optimized for AstroSage screenshots</p>
        </header>

        <div class="bg-slate-800 p-8 rounded-2xl border-2 border-dashed border-slate-600 text-center mb-6">
            <input type="file" id="chartUpload" accept="image/*" class="hidden">
            <label for="chartUpload" class="cursor-pointer bg-sky-600 hover:bg-sky-500 px-8 py-4 rounded-xl font-bold transition inline-block text-lg">
                ðŸ“· Scan AstroSage Table
            </label>
            <div id="loading" class="hidden mt-6 flex flex-col items-center">
                <div class="spinner mb-2"></div>
                <p class="text-sky-400 font-medium">Reading Chart Data...</p>
            </div>
        </div>

        <div id="chartDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10"></div>

        <div class="bg-black/40 p-4 rounded-lg border border-slate-800">
            <h4 class="text-slate-500 text-xs font-bold uppercase mb-2">AI Vision Log (Debug)</h4>
            <div id="debugLog" class="text-xs text-slate-400 font-mono h-24 overflow-y-auto">Waiting for upload...</div>
        </div>
    </div>

    <script>
        const zodiacData = [
            { sign: "Aries", abbr: ["ari", "aries"], lord: "Mars" },
            { sign: "Taurus", abbr: ["tau", "taurus"], lord: "Venus" },
            { sign: "Gemini", abbr: ["gem", "gemini"], lord: "Mercury" },
            { sign: "Cancer", abbr: ["can", "cancer"], lord: "Moon" },
            { sign: "Leo", abbr: ["leo"], lord: "Sun" },
            { sign: "Virgo", abbr: ["vir", "virgo"], lord: "Mercury" },
            { sign: "Libra", abbr: ["lib", "libra"], lord: "Venus" },
            { sign: "Scorpio", lord: "Mars", abbr: ["sco", "scorpio"] },
            { sign: "Sagittarius", abbr: ["sag", "sagittarius"], lord: "Jupiter" },
            { sign: "Capricorn", abbr: ["cap", "capricorn"], lord: "Saturn" },
            { sign: "Aquarius", abbr: ["aqu", "aquarius"], lord: "Saturn" },
            { sign: "Pisces", abbr: ["pis", "pisces"], lord: "Jupiter" }
        ];

        const planets = ["Sun", "Mon", "Mar", "Mer", "Jup", "Ven", "Sat", "Rah", "Ket"];

        const housePurpose = {
            1: "Identity & Physicality", 2: "Wealth & Family", 3: "Efforts & Skills",
            4: "Inner Peace & Home", 5: "Intelligence & Luck", 6: "Obstacles & Service",
            7: "Union & Contracts", 8: "Research & Longevity", 9: "Wisdom & Faith",
            10: "Action & Career", 11: "Fulfillment & Gains", 12: "Release & Spirituality"
        };

        document.getElementById('chartUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const log = document.getElementById('debugLog');
            const load = document.getElementById('loading');
            
            load.style.display = 'flex';
            log.innerHTML = "Initializing OCR...";

            try {
                const { data: { text } } = await Tesseract.recognize(file, 'eng');
                load.style.display = 'none';
                const cleanText = text.toLowerCase();
                log.innerHTML = "AI Detected: " + cleanText.substring(0, 200) + "...";
                
                processChart(cleanText);
            } catch (err) {
                log.innerHTML = "Error: " + err.message;
                load.style.display = 'none';
            }
        });

        function processChart(text) {
            // Find Lagna specifically
            let ascSign = null;
            let lagPos = text.indexOf("lag");
            
            if (lagPos !== -1) {
                let segment = text.substring(lagPos, lagPos + 30);
                ascSign = zodiacData.find(z => z.abbr.some(a => segment.includes(a)));
            }

            if (!ascSign) {
                alert("Could not find Lagna abbreviation. Try manual selection or a clearer crop.");
                return;
            }

            // Map Planets
            let results = {};
            planets.forEach(p => {
                let pPos = text.indexOf(p.toLowerCase());
                if (pPos !== -1) {
                    let pSeg = text.substring(pPos, pPos + 30);
                    let foundSign = zodiacData.find(z => z.abbr.some(a => pSeg.includes(a)));
                    if (foundSign) results[p] = foundSign.sign;
                }
            });

            renderHouses(ascSign.sign, results);
        }

        function renderHouses(ascName, planetMap) {
            const startIdx = zodiacData.findIndex(z => z.sign === ascName);
            const container = document.getElementById('chartDisplay');
            container.innerHTML = '';

            for (let i = 0; i < 12; i++) {
                const houseNum = i + 1;
                const sign = zodiacData[(startIdx + i) % 12];
                const housePlanets = Object.keys(planetMap).filter(k => planetMap[k] === sign.sign);

                container.innerHTML += `
                    <div class="house-card p-5 rounded-xl border border-slate-700">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sky-400 font-black">H${houseNum}</span>
                            <span class="text-[10px] text-slate-500 font-bold uppercase">${sign.sign}</span>
                        </div>
                        <h3 class="text-sm font-bold text-white mb-2">Lord: ${sign.lord}</h3>
                        <div class="min-h-[40px] mb-3">
                            ${housePlanets.map(p => `<span class="planet-tag">${p}</span>`).join('') || '<span class="text-slate-600 text-xs">No Planets</span>'}
                        </div>
                        <p class="text-[11px] text-slate-400 leading-tight border-t border-slate-800 pt-3 italic">"${housePurpose[houseNum]}"</p>
                    </div>`;
            }
        }
    </script>
</body>
</html>
